<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
    <!-- 網站用版本 4.6 -->
</head>
<body>
    <table class="table gk-default-table nowrap default-v-m dataTable no-footer table-hover" style="width: 100%;">
        <thead>
        <tr>
            <th scope="col" class="text-left">楼层</th>
            <th scope="col" class="text-left">面积</th>
            <th scope="col" class="text-left">户，位</th>
            <th scope="col" class="text-left"></th>
        </tr>
        </thead>
        <tbody>

                                                        <tr data-hid="0" data-did="1">
                <td scope="row" class="text-left">1樓</td>
                <td class="text-left">39.00</td>
                <td class="text-left">3</td>
                <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#s_creationModal" data-title="src.樓編輯" data-id="s_t2" data-h1="1樓" data-h2="39" data-h3="39" data-h4="3" data-h5="0" data-h6="0" data-h7="0" data-h8="0" data-h9="" data-h10="0" data-h11="0" data-h12="" data-h13="" data-h14="0" data-h15="0" data-h16="0" data-h17="0" data-h18="0">编辑</button></td>
            </tr>
                                                        <tr data-hid="1" data-did="2">
                <td scope="row" class="text-left">2樓</td>
                <td class="text-left">39.00</td>
                <td class="text-left">3</td>
                <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#s_creationModal" data-title="src.樓編輯" data-id="s_t2" data-h1="2樓" data-h2="39" data-h3="39" data-h4="3" data-h5="0" data-h6="0" data-h7="0" data-h8="0" data-h9="" data-h10="0" data-h11="0" data-h12="" data-h13="" data-h14="0" data-h15="0" data-h16="0" data-h17="0" data-h18="0">编辑</button></td>
            </tr>
                                                        <tr data-hid="2" data-did="3">
                <td scope="row" class="text-left">3樓</td>
                <td class="text-left">39.00</td>
                <td class="text-left">3</td>
                <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#s_creationModal" data-title="src.樓編輯" data-id="s_t2" data-h1="3樓" data-h2="39" data-h3="39" data-h4="3" data-h5="0" data-h6="0" data-h7="0" data-h8="0" data-h9="" data-h10="0" data-h11="0" data-h12="" data-h13="" data-h14="0" data-h15="0" data-h16="0" data-h17="0" data-h18="0">编辑</button></td>
            </tr>
                                                        <tr data-hid="3" data-did="4">
                <td scope="row" class="text-left">地下1層</td>
                <td class="text-left">30.00</td>
                <td class="text-left">3</td>
                <td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#s_creationModal" data-title="src.樓編輯" data-id="s_t2" data-h1="地下1層" data-h2="30" data-h3="0" data-h4="0" data-h5="0" data-h6="0" data-h7="0" data-h8="0" data-h9="" data-h10="30" data-h11="3" data-h12="" data-h13="" data-h14="0" data-h15="0" data-h16="0" data-h17="0" data-h18="0">编辑</button></td>
            </tr>
                                                    </tbody>
    </table>


    <!-- sky -->
    <!-- Modal -->
    <div class="modal fade" id="s_creationModal" tabindex="-1" aria-labelledby="s_creationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="s_creationModalLabel">New message</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            <!-- modal-body Content-->
            <!--
                data-tid=s_t1 表示這是 全区的欄位資料
                ex: 户 就是 data-tid=s_t4
                // 自訂功能 //
            -->
            <!-- 棟的資料 -->
            <div data-tid="s_t1">
                <div class="col-12 col-md-6">
                    <div class="form-group">
                    <label>src.原棟號</label>
                    <input type="text" class="form-control" data-name="chuangs_name_ori" data-guise="input" readonly>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="form-group">
                    <label>src.新棟號</label>
                    <input type="text" class="form-control" data-name="chuangs_name_new" data-guise="input">
                    </div>
                </div>
            </div>
            <!-- 樓的資料 -->
            <div class="d-none" data-tid="s_t2">
                <div class="form-group">
                  <label>樓層</label>
                  <input type="text" class="form-control" data-name="lou_name" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>總面積</label>
                  <input type="text" class="form-control" data-name="lou_tot_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>住戶面積</label>
                  <input type="text" class="form-control" data-name="lou_a_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>住戶戶數</label>
                  <input type="text" class="form-control" data-name="lou_a_count" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>商業面積</label>
                  <input type="text" class="form-control" data-name="lou_c_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>商業戶數</label>
                  <input type="text" class="form-control" data-name="lou_c_count" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>物業用房</label>
                  <input type="text" class="form-control" data-name="lou_h_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>人房面積</label>
                  <input type="text" class="form-control" data-name="lou_e_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>位</label>
                  <input type="text" class="form-control" data-name="lou_e_count" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>車庫面積</label>
                  <input type="text" class="form-control" data-name="lou_g_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>車庫間數</label>
                  <input type="text" class="form-control" data-name="lou_g_count" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>公共車位</label>
                  <input type="text" class="form-control" data-name="lou_0" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>位</label>
                  <input type="text" class="form-control" data-name="lou_1" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>單間車庫面積</label>
                  <input type="text" class="form-control" data-name="lou_g_area2" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>單間車庫數量</label>
                  <input type="text" class="form-control" data-name="lou_g_count2" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>儲藏室面積</label>
                  <input type="text" class="form-control" data-name="lou_d_area" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>儲藏室間數</label>
                  <input type="text" class="form-control" data-name="lou_d_count" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>其他面積</label>
                  <input type="text" class="form-control" data-name="lou_i_area" data-guise="input" readonly>
                </div>

            </div>
            <!-- 戶的資料 -->
            <div class="d-none" data-tid="s_t3">
                <div class="form-group">
                  <label>戶</label>
                  <input type="text" class="form-control" data-name="hu_name" data-guise="input">
                </div>
                <div class="form-group">
                  <label>用途</label>
                  <!-- <input type="text" class="form-control" data-name="hu_use"> -->
                  <select class="form-control" data-name="hu_use" data-guise="input">
                                            <option value="a">住宅</option>
                                            <option value="b">別墅</option>
                                            <option value="c">商業</option>
                                            <option value="d">儲藏庫</option>
                                            <option value="e">人防車位</option>
                                            <option value="f">汽車位</option>
                                            <option value="g">單間車庫</option>
                                            <option value="h">物業用房</option>
                                            <option value="i">其他</option>
                                      </select>
                </div>
                <div class="form-group">
                  <label>面積</label>
                  <input type="number" class="form-control" data-name="hu_area" data-guise="input">
                </div>
                <div class="form-group">
                  <label>電號</label>
                  <input type="text" class="form-control" data-name="hu_ele" data-guise="input">
                </div>
                <div class="form-group">
                  <label>水號</label>
                  <input type="text" class="form-control" data-name="hu_water" data-guise="input">
                </div>
                <div class="form-group">
                  <label>煤氣</label>
                  <input type="text" class="form-control" data-name="hu_gas" data-guise="input">
                </div>
                <div class="form-group">
                  <label>電視</label>
                  <input type="text" class="form-control" data-name="hu_tv" data-guise="input">
                </div>
            </div>
            <!-- 更改建立人 -->
            <div class="d-none" data-tid="s_t4">
                <div class="form-group">
                    <label>src.原建立人</label>
                    <input type="text" class="form-control" data-name="chuangs_name" data-guise="input" readonly>
                </div>
                <div class="form-group">
                  <label>src.原建立人</label>
                  <select class="form-control" data-name="change_creator" data-guise="input">
                        <option value="1">建立人0</option>
                        <option value="2">建立人1</option>
                        <option value="3">建立人2</option>
                  </select>
                </div>
            </div>
            <!-- modal-body Content end -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">src.關閉</button>
              <button type="button" class="btn btn-primary" id="s_submit">储存</button>
            </div>
          </div>
        </div>
      </div>
      <script type="text/javascript">
        // sky
            //Tab數量(可設定上限，全出、棟、樓、戶)
            let TabNumber = 10;
            //要送出與更新頁面的資料(丟後端)
            let AllarrayS = [];
            //共用Tab key設定
            // s_t1 表示頁面上有幾個Tab
            // 這邊主要在取Obj key 名稱，可以減少進去裡面尋找
            //== 自訂功能 ==// (s_Building可修改，作為辨識修改哪個檔案)
            let TabKeyAll = {"s_t1":"s_Building","s_t2":"s_Floor","s_t3":"s_Household"};
            //== 自訂功能 ==//
            //ajax對應的Url
            let TabKeyUrlAll = {"s_t1":"/ajax_chuang_edit", "s_t2":"/test2", "s_t3":"/test3"};

            //Modal js
            $('#s_creationModal').on('show.bs.modal', function (event) {
                let button = $(event.relatedTarget);

                //== Modal標題資料 ==//
                let ModalTitle = button.data('title') ? button.data('title') : false;
                console.log('標題 :'+ModalTitle);

                //== 取得 data-id ==//
                let Tabid = button.data('id') ? button.data('id') : false;
                console.log('Tab id :'+Tabid);
                // console.log(document.querySelector('[data-tid="'+Tabid+'"]'));

                //== 取得 data-did ==//
                let Tab_didTag = event.relatedTarget.parentElement != false ?  (event.relatedTarget.parentElement.parentElement != false ? event.relatedTarget.parentElement.parentElement : false ) : false;
                let Tab_did = Tab_didTag !=false ? (Tab_didTag.dataset.did !=false ? Tab_didTag.dataset.did : false ) : false;
                console.log('Tab_did :'+Tab_did);

                //== 取得目前第幾行 有順序問題不可以移動編輯按鈕==//
                let Tabhid = false;
                if(event.relatedTarget.parentElement.parentElement)
                {
                    //取得按鈕上層位置
                    let TabTr = event.relatedTarget.parentElement.parentElement;
                    //取得 data-hid 的值
                    Tabhid = TabTr.dataset.hid ? TabTr.dataset.hid : false;
                }

                //== 判斷Modal顯示的資料 ==//
                if(Tabid != false && document.querySelector('[data-tid="'+Tabid+'"]'))
                {
                    //== 先將所有Modal資料隱藏 ==//
                    for(let i=1; i<= TabNumber; i++)
                    {
                         //== 判斷data-tid是否存在 ==//
                        if(document.querySelector('[data-tid="s_t'+i+'"]'))
                        {
                            document.querySelector('[data-tid="s_t'+i+'"]').classList.add('d-none');
                        }
                    }
                    //== 顯示正確資料 ==//
                    document.querySelector('[data-tid="'+Tabid+'"]').classList.remove('d-none');
                }
                else
                {
                    console.error("Modal資料顯示出錯");
                }

                //== 取得列表資料 ==//
                //data-h1資料有10個
                let array = {};
                let k = 0;
                //取得欄位名稱
                for(let i=0; i<= 20; i++)
                {
                    k= i+1;
                    //檢查是否有data-h1 ~ data-h10
                    if(event.relatedTarget.getAttribute('data-h'+k))
                    {
                        //array["h"+k] = button.data('h'+k);
                        array["h"+k] = event.relatedTarget.getAttribute('data-h'+k);
                    }
                }

                //== 取得資料的詳細名稱 ==//
                let TabClass = document.querySelector('[data-tid="'+Tabid+'"]');
                // let stInpus = TabClass.querySelectorAll('input');
                let stInpus = TabClass.querySelectorAll('[data-guise="input"]');
                console.log(stInpus);
                let i = 1;

                console.log(array);
                stInpus.forEach(item=>{
                    console.log("寫回Modal");
                    console.log("h"+i);
                    console.log(array["h"+i]);
                    item.value = array["h"+i];
                    i++;
                });

                //== 將資料寫上去Modal ==//
                var modal = $(this);
                //標題
                modal.find('.modal-title').text(ModalTitle);
                 //== 將送出按鈕添加 目前顯示的資料是哪個tab ==//
                if(Tabid && Tabhid && Tab_did)
                {
                    modal.find('#s_submit').attr('data-id',Tabid);
                    modal.find('#s_submit').attr('data-hid',Tabhid);
                    modal.find('#s_submit').attr('data-did',Tab_did);
                }
                else
                {
                    console.error("取得列表欄位出錯，data-id、data-hid、Tab_did 取得失敗");
                }
            });

            //儲存按鈕送出
            $('#s_submit').on('click',function(event){
                let target = event.target;
                //== 取得 Tab id  與 行數id (用來回寫) ==//
                // console.log(event);
                let sid = target.dataset.id ? target.dataset.id: false;
                let hid = target.dataset.hid ? target.dataset.hid: false;
                let did = target.dataset.did ? target.dataset.did: false;
                console.log("sid :" + sid);
                console.log("hid :" + hid);
                console.log("did :" + did);
                //以下都不可以是false
                if(!sid && !hid && !did)
                {
                    alert("取得 sid、hid、did 失敗，請檢查");
                }
                //Modal id
                let Modal = document.getElementById('s_creationModal');

                //抓Modal的欄位(抓取上方修改的資料)
                let st1Tag = Modal.querySelector('[data-tid="'+sid+'"]') ? Modal.querySelector('[data-tid="'+sid+'"]') : false;
                // let st1Inpus = st1Tag.querySelectorAll('input') ? st1Tag.querySelectorAll('input') : false;
                let st1Inpus = st1Tag.querySelectorAll('[data-guise="input"]') ? st1Tag.querySelectorAll('[data-guise="input"]') : false;
                if(st1Inpus)
                {
                    let st1_array = {};
                    //將資料整理到obj
                    st1Inpus.forEach(item=>{
                        st1_array[item.dataset.name] = item.value;
                        // console.log(item.value);
                    });
                    //整理資料
                    AllarrayS = [];
                    //== 依據Tab取名 ==//
                    let Job = { _token: $("meta[name='csrf-token']").attr('content') };
                    Job[TabKeyAll[sid]] = st1_array;
                    //寫入共用陣列
                    AllarrayS.push({'Data':Job,'Tabsid':sid,'Tabhid':hid,'Tabdid':did,'Url':TabKeyUrlAll[sid]});
                }

                let this_url = '';
                if(sid=='s_t1'){ this_url = '/ajax_chuang_edit';
                }else if(sid=='s_t2'){ this_url = '/ajax_lou_edit';
                }else if(sid=='s_t3'){ this_url = '/ajax_hu_edit'; }

                //送入ajax
                ajax_submit(AllarrayS[0], this_url);

            });

            function ajax_submit(json, this_url)
            {
                $.ajax({
                    // url: json.url,
                    url:this_url,
                    method: "post",
                    data:
                    {
                        _token: $("meta[name='csrf-token']").attr('content'),
                        json
                    },
                    success: function (res) {
                        if (res.status == "success") {
                            UpdatePageS();
                            alert('src.更新成功');
                        }else{
                            alert('發生錯誤');
                        }
                    },
                    error: function () {
                        UpdatePageS();
                        alert('src.存儲失敗');

                    },
                });
            }

            function UpdatePageS()
            {
                //抓取共用陣列來知道目前更新的是誰
                let sid = AllarrayS[0].Tabsid;
                let tableTag = document.querySelector('table[data-id="'+sid+'"]') ? document.querySelector('table[data-id="'+sid+'"]') : false;
                let tableH = AllarrayS[0].Tabhid;
                let did = AllarrayS[0].Tabdid;
                if(tableTag)
                {
                    let Tr = tableTag.querySelector('[data-did="'+did+'"]') != false ? tableTag.querySelector('[data-did="'+did+'"]') : false;
                    if(!Tr)
                    {
                        alert('回寫資料 UpdatePageS()，無法取得did，請檢查原始碼Tr是否有 data-did');
                    }
                    let Th = Tr.querySelector('th')
                    let Td = Tr.querySelectorAll('td');
                    let TdButton = Td[Td.length -1].querySelector('button');
                    let newjob = {};
                    //== 依據Tab取名==//
                    //將資料寫進去空白Obj裏面
                    newjob = AllarrayS[0].Data[TabKeyAll[sid]];
                    //只有取值不取key
                    let newValue = Object.values(newjob);
                    //將資料寫回區表格裡面
                    Th.textContent = newValue[0];
                    for(let i=0; i<(newValue.length - 1);i++)
                    {
                        Td[i].textContent = newValue[i+1];
                    }
                    //修改按鈕上的欄位
                    for(let i=0; i<=newValue.length;i++)
                    {
                        TdButton.dataset['h'+Number(i+1)] = newValue[i];
                    }
                }

                $('#s_creationModal').modal('hide');
            }
        </script>

        <script type="text/javascript">
            // ajax
            function chuang_del(chuangid)
            {
            $.ajax({
                    url: "/ajax_chuang_del",
                    method: "post",
                    data: {
                        _token: $("meta[name='csrf-token']").attr('content'),
                        chuangid: chuangid
                    },
                    error: function () {
                        Swal.close();
                        alert('發生錯誤(estate_index_ajax0)');
                    },
                    success: function (res) {
                        Swal.close();
                        if (res.status != "success") {
                            alert('發生錯誤(estate_index_ajax1)');
                        }else{
                            if(res.result=="del_data_not_exist"){
                                alert('刪除資料不存在');
                            }else if(res.result=="wrong"){
                                alert('發生錯誤(estate_index_ajax2)');
                            }else if(res.result=="deleted"){
                                $("#trch_"+chuangid).remove();
                            }
                        }
                        // console.log(res.result);
                    }
                });
            }
        </script>
</body>
</html>