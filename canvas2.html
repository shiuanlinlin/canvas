<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>canvas</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <div class="row" id="form">
        <div class="col-4 border">
            <canvas id="canvas" width="600" height="600">
                Sorry, your browser doesn't support the <canvas> element.
            </canvas>
        </div>
        <div class="col-2 border p-3">
            <div class="mb-3">
                <label for="drawWidth" class="form-label">版面寬度</label>
                <input type="number" class="form-control" id="drawWidth" name="width" placeholder="寬度" value="">
                <div class="form-text">*最小寬度限制300，最大600</div>
            </div>
            <div class="mb-3">
                <label for="drawHeight" class="form-label">版面高度</label>
                <input type="number" class="form-control" id="drawHeight" name="height" placeholder="高度" value="">
                <div class="form-text">*最小高度限制300，最大600</div>
            </div>
            <div class="mb-3 d-flex">
                <button type="button" class="btn btn-success btn-sm ms-auto" data-action="categoryBtn">添加</button>
            </div>
            <!-- 添加類別 category-->
            <div id="category">
                <div class="mb-3" data-id="category_1" data-category="true">
                    <div class="row g-3">
                        <div class="col-2">
                            <button type="button" class="btn btn-danger" data-action="delcategory" data-sid="category_1">-</button>
                        </div>
                        <div class="col-5">
                            <input type="text" class="form-control" name="category_1" placeholder="類別名稱">
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control" max="90" name="categoryFraction_1" placeholder="分數">
                        </div>
                        <div class="col-2">
                            <input type="color" class="form-control form-control-color" value="#FF6384" title="Choose your color">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-secondary" data-action="submitBtn">送出</button>
            <button type="button" id="Clearbtn" class="btn btn-secondary d-none" data-action="Clearbtn">清除畫布</button>
            <button type="button" id="ClearlocalStorage" class="btn btn-secondary d-none" data-action="ClearlocalStorage">清除紀錄</button>
        </div>
    </div>

    <script>
        var _canvas = document.getElementById('canvas');

        //判斷是否支援
        if (_canvas.getContext) {
            var ctx = _canvas.getContext('2d');
            //draw()
        }else {
            alert('your browser not support canvas')
            //如果不支援
        }

        function draw(xwidth,xheight,categoryArray)
        {

            //共用左側基礎點
            let xSpace = 20; // x軸左側的起始空白
            const yTextColor = 'rgb(102,102,102)';
            //長條圖的寬度
            var fillwidth = (Number(xwidth) / categoryArray.length) - 10;
            let y = Number(xheight/100);
            let h = Number(xheight/10); // 主要y軸差距

            ctx.fillStyle = '#FFF';
            ctx.fillRect (0, xSpace, Number(xwidth)+(xSpace*2), xheight);

            // X 軸虛線 ==
            let Xborder = 11;
            let blankNum = Number(xheight / 10);
            for(let i=1; i<Xborder; i++)
            {
                ctx.fillStyle = yTextColor;
                ctx.fillText(100 - i*10, 5, blankNum*i); //左側刻度
                ctx.fillStyle = "rgb(163 163 163 / 25%)";
                ctx.fillRect (xSpace, blankNum*i, xwidth, 1); // fillRect(x, y, width, height)
            }

            // y 軸
            ctx.fillStyle = "rgb(206,206,206)";
            ctx.fillRect (xSpace, h, 1, xheight - h);
            // X 軸
            ctx.fillStyle = "rgb(206,206,206)";
            ctx.fillRect (xSpace, xheight, xwidth, 1); // fillRect(x, y, width, height)

            // X軸文字
            categoryArray.forEach((item,index,arr)=>{
                let x = (fillwidth + 10)*index;
                ctx.fillStyle = yTextColor;
                ctx.textAlign="center";
                ctx.fillText(item.name,10+xSpace+x+Number(fillwidth/2), Number(xheight)+10);
            });

            // 線條
            categoryArray.forEach((item,index,arr)=>{
                let x = (fillwidth + 10)*index;
                //線條顏色
                ctx.strokeStyle = item.color;
                ctx.strokeRect(10+xSpace+x,( Number(xheight) - Number(item.value*y)),fillwidth, Number(item.value*y));
            });

            // X 軸 : 邊距 10
            // y 軸 : 總長 400 - 50高度
            categoryArray.forEach((item,index,arr)=>{
                let x = (fillwidth + 10)*index;
                ctx.globalAlpha = 0.4;
                ctx.fillStyle = item.color;
                ctx.fillRect (10+xSpace+x, ( Number(xheight) - Number(item.value*y)), fillwidth, Number(item.value*y));
            });
        }

        const submitBtn = document.querySelector('button[type="submit"]');
        const form = document.getElementById('form');
        const Clearbtn = document.querySelector('[data-action="Clearbtn"]');
        const ClearlocalStorage = document.querySelector('[data-action="ClearlocalStorage"]');
        const category = document.getElementById('category');
        const categoryBtn = document.querySelector('[data-action="categoryBtn"]');

        //寬度與高度
        const xwidth = form.querySelector('[name="width"]');
        const xheight = form.querySelector('[name="height"]');

        window.onload = function()
        {
            let obj = JSON.parse(localStorage.getItem('canvas'));

            if(obj != null && obj.category != null)
            {
                let categoryList = obj.category;
                xwidth.value = obj.xwidth;
                xheight.value = obj.xheight;

                let Html = '';

                for(let i=0; i<categoryList.length;i++)
                {
                    Html += `
                        <div class="mb-3" data-id="category_${i+1}" data-category="true">
                            <div class="row g-3">
                                <div class="col-2">
                                    <button type="button" class="btn btn-danger" data-action="delcategory" data-sid="category_${i+1}">-</button>
                                </div>
                                <div class="col-5">
                                    <input type="text" class="form-control" name="category_${i+1}" placeholder="類別名稱" value="${ categoryList[i].name }">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control" name="categoryFraction_${i+1}" max="90" placeholder="分數" value="${ categoryList[i].value }">
                                </div>
                                <div class="col-2">
                                    <input type="color" class="form-control form-control-color" name="categoryColor_${i+1}" value="${ categoryList[i].color }">
                                </div>
                            </div>
                        </div>
                    `;
                }
                category.innerHTML = Html;
            }
            console.log(obj);
        }

        form.addEventListener('click', event=>{
            let target = event.target;
            let action = ('action' in target.dataset) ? target.dataset.action : false;
            switch(action)
            {
                case 'submitBtn':
                    const xwidthValue = form.querySelector('[name="width"]').value;
                    const xheightValue = form.querySelector('[name="height"]').value;
                    let categorysLists = document.querySelectorAll('[data-category="true"]');
                    submitBtn.classList.add('d-none');
                    Clearbtn.classList.remove('d-none');
                    ClearlocalStorage.classList.remove('d-none');

                    //將欄位鎖住
                    let inputs = document.querySelectorAll('input[type="text"]');
                    let inputsNum = document.querySelectorAll('input[type="number"]');
                    let inputsColor = document.querySelectorAll('input[type="color"]');
                    let delcategorys = document.querySelectorAll('[data-action="delcategory"]');

                    inputs.forEach(item=>{
                        item.disabled = true;
                    });

                    inputsColor.forEach(item=>{
                        item.disabled = true;
                    });

                    inputsNum.forEach(item=>{
                        item.disabled = true;
                    });

                    delcategorys.forEach(item=>{
                        item.disabled = true;
                    });

                    categoryBtn.disabled = true;

                    //抓取類別
                    let categoryArray = [];
                    categorysLists.forEach(item =>{
                        categoryArray.push({'name':item.querySelector('input[type="text"]').value,'color': item.querySelector('input[type="color"]').value,'value': item.querySelector('input[type="number"]').value});
                    });

                    if(xwidthValue != "" && xheightValue != "")
                    {
                        let obj = {'xwidth':xwidthValue,'xheight':xheightValue , 'category': categoryArray};
                        localStorage.setItem('canvas', JSON.stringify(obj));
                        draw(xwidthValue,xheightValue,categoryArray);
                    }
                    break;
                case 'categoryBtn':
                    //添加
                    let categoryList = document.querySelectorAll('[data-category="true"]');
                    let Html = `
                        <div class="row g-3">
                            <div class="col-2">
                                <button type="button" class="btn btn-danger" data-action="delcategory" data-sid="category_${categoryList.length + 1}">-</button>
                            </div>
                            <div class="col-5">
                                <input type="text" class="form-control" name="category_${categoryList.length + 1}" placeholder="類別名稱">
                            </div>
                            <div class="col-3">
                                <input type="number" class="form-control" name="categoryFraction_${categoryList.length + 1}" max="90" placeholder="分數">
                            </div>
                            <div class="col-2">
                                <input type="color" class="form-control form-control-color" name="categoryColor_${categoryList.length+1}" value="#FF6384" title="Choose your color">
                            </div>
                        </div>
                    `;
                    let div = document.createElement('div');
                    div.classList.add('mb-3');
                    div.dataset.id = 'category_'+(categoryList.length + 1);
                    div.dataset.category = 'true';
                    div.innerHTML = Html;
                    category.append(div);
                    break;
                case 'delcategory':
                    //移除類別
                    let dataid = target.dataset.sid;
                    document.querySelector(`[data-id="${dataid}"]`).remove();
                    let categoryLists = document.querySelectorAll('[data-category="true"]');

                    categoryLists.forEach((item,index,arr) =>{
                        item.dataset.id = "category_" + (index+1);
                        item.querySelector('[data-action="delcategory"]').dataset.sid = "category_" + (index+1);
                        item.querySelector('input[type="text"]').name = "category_" + (index+1);
                        item.querySelector('input[type="number"]').name = "categoryFraction_" + (index+1);
                    });
                    //重新設定id
                    console.log(dataid);
                    console.log(categoryLists);
                    break;
                case 'Clearbtn':
                    //清除畫布
                    location.reload();
                    break;
                case 'ClearlocalStorage':
                    //清除紀錄與畫布
                    localStorage.removeItem('canvas');
                    xwidth.value = '';
                    xheight.value = '';

                    let Htmls = `
                        <div class="mb-3" data-id="category_1" data-category="true">
                            <div class="row g-3">
                                <div class="col-2">
                                    <button type="button" class="btn btn-danger" data-action="delcategory" data-sid="category_1">-</button>
                                </div>
                                <div class="col-5">
                                    <input type="text" class="form-control" name="category_1" placeholder="類別名稱">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control" name="categoryFraction_1" max="90" placeholder="分數">
                                </div>
                                <div class="col-2">
                                    <input type="color" class="form-control form-control-color" name="categoryColor_1" value="#FF6384" title="Choose your color">
                                </div>
                            </div>
                        </div>
                    `;
                    category.innerHTML = Htmls;

                    setTimeout(function(){
                        location.reload();
                    },100);
                    break;
            }
        });

        // submitBtn.addEventListener('click', event=>{
        //     const xwidthValue = form.querySelector('[name="width"]').value;
        //     const xheightValue = form.querySelector('[name="height"]').value;
        //     submitBtn.classList.add('d-none');
        //     Clearbtn.classList.remove('d-none');
        //     ClearlocalStorage.classList.remove('d-none');
        //     if(xwidthValue != "" && xheightValue != "")
        //     {
        //         let obj = {'xwidth':xwidthValue,'xheight':xheightValue};
        //         localStorage.setItem('canvas', JSON.stringify(obj));
        //         draw(xwidthValue,xheightValue)
        //     }
        // });

        //清除畫布
        // Clearbtn.addEventListener('click', event=>{
        //     location.reload();
        // });

        //清除紀錄與畫布
        // ClearlocalStorage.addEventListener('click', event=>{
        //     localStorage.removeItem('canvas');
        //     xwidth.value = '';
        //     xheight.value = '';
        //     setTimeout(function(){
        //         location.reload();
        //     },100);
        // });

    </script>
    <style type="text/css">
        /* canvas { border: 1px solid rgb(174, 174, 174); } */
        body{
            overflow: hidden;
        }
        canvas { margin: 50px 80px; }
        #category img{ display: none; }
        input[type='number'] {
            -moz-appearance:textfield;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
    </style>
</body>
</html>